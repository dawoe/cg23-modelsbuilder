<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />

    <title>ModelsBuilder : Beyond PureLive - Codegarden 23</title>

    <link rel="stylesheet" href="dist/reset.css" />
    <link rel="stylesheet" href="dist/reveal.css" />
    <link rel="stylesheet" href="dist/theme/dotcontrol.css" />

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css" />
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section data-transition="convex">
          <h1>ModelsBuilder</h1>
          <h2>Beyond PureLive</h2>
        </section>
        <section>
          <h2>Introduction</h2>
          <ul>
            <li>Dave Woestenborghs</li>
            <li>Work at <a href="https://dotcontrol.com/">DotControl</a></li>
            <li>Umbraco MVP (8x)</li>
            <li>Active community member since 2008</li>
            <li>Part of the 24 days in Umbraco team</li>
            <li>Honorary member of Umbraco Packages Community team.</li>
          </ul>
          <aside class="notes">
            Data drive agency with offices in r'dam, heerlen and curacoa<br />
            MVP since 2016<br />
            First blog written in 2008
          </aside>
        </section>
        <section data-transition="convex">
          <h1>History</h1>
        </section>
        <section>
          <p>First released as a open source package called <a href="https://our.umbraco.com/packages/developer-tools/zbumodelsbuilder/" target="_blank">Zbu.Modelsbuilder</a> in 2014 by  
            former HQ employee <a href="https://www.zpqrtbnk.net/" target="_blank">Stephan Gay</a>.
          </p>
        </section>       
        <section>
          <p>In 2016 this was rebranded to <a href="https://www.nuget.org/packages/Umbraco.ModelsBuilder">Umbraco.Modelsbuilder</a> and shipped with Umbraco 7.4.</p><p>But it was still a open source package maintained seperatly from Umbraco CMS.
          </p>
        </section>  
        <section>
          <p>In 2020 a slimmed down version was embedded in to Umbraco 8.5</a>
          </p>
          <aside class="notes">
            Stephan left HQ.
          </aside>
        </section>
        <section>
          <h1>How does it work</h1>
        </section>     
        <section>
          <p>
            Models builder generates a <u>partial</u> C# class for each document type in your CMS with a filename : <br> DocTypeAlias.generated.cs
          </p>
        </section>
        <section>
          <p>
            The generated class will inherit from PublishedContentModel or PublishedElementModel depending on the document type configuration.          
          </p>          
        </section>
        <section>
          <p>Each property on your doctype will be a property in the generated C# class with the correct CLR type returned by the property value converter</p>
        </section>
        <section>
          <pre >
            <code data-trim data-noescape class="language-csharp medium">
              [PublishedModel("blog")] 
              public partial class Blog : PublishedContentModel
              {         
                public new const string ModelTypeAlias = "blog";       

                [global::System.Diagnostics.CodeAnalysis.MaybeNull]
                [ImplementPropertyType("howManyPostsShouldBeShown")]
                public virtual decimal HowManyPostsShouldBeShown 
                  => this.Value<decimal>(_publishedValueFallback, "howManyPostsShouldBeShown");
              }
            </code>
          </pre>
        </section>       
        <section>
          <p>Document types that inherits from another doctype will use C# inheritance.</p>
        </section>
        <section>
          <pre>
            <code data-trim data-noescape class="language-csharp large">
              [PublishedModel("news")]
              public partial class News : Blog
              {                
              }
            </code>
          </pre>
        </section>
        <section>
          <p>Document types that are used as a composition in another document type will have a interface generated besides a concrete class implementing the generated interface.           
          </p>
        </section>
        <section>
          <p>Each document type that uses the composition will implement the interface.            
          </p>
        </section>
        <section>
          <p>For each property on the composition document type a static "Get" method will be implemented, which will be used in composed document types.
          </p>
        </section>
        <section>
          <pre>
            <code data-trim data-noescape class="language-csharp large">
              public partial interface IContentBase : IPublishedContent
              {
                [global::System.Diagnostics.CodeAnalysis.MaybeNull]
                BlockGridModel BodyText { get; }                
              }
            </code>
          </pre>
        </section>
        <section>
          <pre>
            <code data-trim data-noescape class="language-csharp medium">
              [PublishedModel("contentBase")]
              public partial class ContentBase : PublishedContentModel, IContentBase
              {
                [global::System.Diagnostics.CodeAnalysis.MaybeNull]
                [ImplementPropertyType("bodyText")]
                public virtual BlockGridModel BodyText => GetBodyText(this, _publishedValueFallback);

                [return: global::System.Diagnostics.CodeAnalysis.MaybeNull]
                public static BlockGridModel GetBodyText(IContentBase that, 
                  IPublishedValueFallback publishedValueFallback) 
                  => that.Value<BlockGridModel>(publishedValueFallback, "bodyText");                
              }
            </code>
          </pre>
        </section>
        <section>
          <pre>
            <code data-trim data-noescape class="language-csharp medium">
              [PublishedModel("contentPage")]
              public partial class ContentPage : PublishedContentModel, IContentBase, INavigationBase
              {
                [global::System.Diagnostics.CodeAnalysis.MaybeNull]
                [ImplementPropertyType("bodyText")]
                public virtual BlockGridModel BodyText
                  => ContentBase.GetBodyText(this, _publishedValueFallback);                          
              }
            </code>
          </pre>
        </section>

        <section>
          <h1>Configuration</h1>
        </section>     
        <section>
          <h2>Default configuration</h2>
          <pre>
            <code data-trim data-noescape class="json medium">
              "Umbraco": {
                "CMS": {
                  "ModelsBuilder": {
                    "ModelsMode": "InMemoryAuto",
                    "ModelsNamespace": "Umbraco.Cms.Web.Common.PublishedModels",
                    "FlagOutOfDateModels": false,
                    "ModelsDirectory": "~/umbraco/models",
                    "AcceptUnsafeModelsDirectory": false,
                    "DebugLevel": 0
                  }
                }
              }
            </code>
          </pre>
        </section>
        <section>
          <h3>ModelsMode</h3>
            <p>Specifies how and when the models are generated.
            </p>           
        </section>
        <section>
          <h3>ModelsMode : Nothing</h3>
            <p>No models are being generated.
              <br>Recommended setting for non-development environments
              <br>or when you are not using the models in your code and markup.
            </p>           
        </section>   
        <section>
          <h3>ModelsMode : InMemoryAuto</h3>
            <p>Models are generated and compiled each time a document type changes.              
            </p> 
            <aside class="notes">
                Models are generated and compiled on the fly.
                Are loaded into memory after compilation.
                Models are only available in the views.
                All models are generated in one .cs file
            </aside>          
        </section>
        <section>
          <h3>ModelsMode : SourceCodeManual</h3>
            <p>Models are generated on request.              
            </p>  
            <aside class="notes">
                Models are generated by clicking a button in the models builder dashboard.
                No compilation happens.
                Each doctype class is a seperate .cs file.
          </aside>            
        </section>
        <section>
          <h3>ModelsMode : SourceCodeAuto</h3>
            <p>Models are generated but not compiled each time a document type changes.             
            </p>  
            <aside class="notes">              
                No compilation happens.
                Each doctype class is a seperate .cs file.
          </aside>            
        </section>   
        <section>
          <h3>ModelsNameSpace</h3>
          <p>The namespace for the generated models.
            <br/> Defaults to Umbraco.Cms.Web.Common.PublishedModels
          </p>
        </section>  
        <section>
          <h3>FlagOutOfDateModels</h3>
            <p>When set to true this will list out of date models in the models builder dashboard.             
            </p>  
            <aside class="notes">              
                Only relevant when SourceCodeManual 
                Model can be out of date when doctype or datatypes change.
          </aside>            
        </section>    
        <section>
          <h3>ModelsDirectory</h3>
            <p>Changes the folder where the models are generated.             
            </p>  
            <aside class="notes">              
                Default is /umbraco/models
                Which is normally excluded from your repo.
          </aside>            
        </section>            
        <section>
          <h3>AcceptUnsafeModelsDirectory</h3>
          <p>Indicates if models can be generated outside of your website root folder.             
          </p>
          <aside class="notes">              
            Set this to true if you want your models to be generated in seperate class library so they can be used in other code as well.
          </aside> 
        </section>
        <section>
          <h3>DebugLevel</h3>
          <p>Set this to a value higher to 0 to have increased logging           
          </p>
          <aside class="notes">              
            Only do this on development environments.
          </aside> 
        </section>

        <section>
          <h1>Benefits</h1>
        </section>
        <section>
          <h2>Property values</h2>
          <pre>
            <code data-trim data-noescape class="cshtml-razor medium">
              @inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

              @{
                  var title = (string)Model.Value("pageTitle");

                  var anotherTitle = Model.Value&lt;string&gt;("pageTitle");
              }

              &lt;h1&gt;@title&lt;/h1&gt;
            </code>
          </pre>
        </section>
        <section>
          <h2>Property values</h2>
          <pre>
            <code data-trim data-noescape class="cshtml-razor medium">
              @inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage&lt;Blog&gt;

              @{
                  var title = Model.PageTitle;
              }

              &lt;h1&gt;@title&lt;/h1&gt;
            </code>
          </pre>
        </section>
        <section>
          <h2>Querying</h2>
          <pre>
            <code data-trim data-noescape class="cshtml-razor medium">
              @inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage;

              @{
                  var blogs = Model.ChildrenOfType(&quot;blogPost&quot;)
                      .OrderByDescending(x =&gt; x.Value&lt;DateTime&gt;(&quot;publicationDate&quot;))
                      .Take(Model.Value&lt;int&gt;(&quot;howManyPostsShouldBeShown&quot;));
              }
            </code>
          </pre>
        </section> 
        <section>
          <h2>Querying</h2>
          <pre>
            <code data-trim data-noescape class="cshtml-razor medium">
              @inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage&lt;Blog&gt;

              @{
                  var blogs = Model.Children&lt;Blogpost&gt;()
                      .OrderByDescending(x =&gt; x.PublicationDate)
                      .Take(Model.HowManyPostsShouldBeShown);
              }
            </code>
          </pre>
        </section>
        <section>
          <h2>Type checking</h2>
          <pre>
            <code data-trim data-noescape class="cshtml-razor medium">
              @inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

              @{
                if (Model.IsDocumentType(&quot;blogPost&quot;))
                {
                    
                }            
              }
            </code>
          </pre>
        </section>  
        <section>
          <h2>Type checking</h2>
          <pre>
            <code data-trim data-noescape class="cshtml-razor medium">
              @inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

              @{
                if (Model is Blogpost blogPost)
                {
            
                }
              }
            </code>
          </pre>
          </section>
          <section>
            <h2>Type checking</h2>
            <pre>
              <code data-trim data-noescape class="cshtml-razor medium">
                @inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

                @{
                    if (Model.IsComposedOf(&quot;contentBase&quot;))
                    {
                        
                    }                   
                }
              </code>
            </pre>
        </section>
        <section>
          <h2>Type checking</h2>
          <pre>
            <code data-trim data-noescape class="cshtml-razor medium">
              @inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

              @{
                  if (Model is IContentBase contentBase)
                  {

                  }
              }
            </code>
          </pre>
        </section>
            
        <section>
          <h1>Extending</h1>
        </section>
        <section>
          <p>Because the models are generated as partial classes they can be extended with custom properties and methods.</p>
          <aside class="notes">              
            Create a partial class with the same name in the configured namespace.
            You can only create custom properties and methods.
            No inheritance, no constructor with same signature and no generated properties.
          </aside> 
        </section>
        <section>
          <pre>
            <code data-trim data-noescape class="language-csharp large">              
              public partial class ContentPage
              {
                  public bool HasPageTitle => 
                    !string.IsNullOrWhiteSpace(this.PageTitle);

                  public string BrowserTitle 
                      => this.HasPageTitle ? this.PageTitle : this.Name;
              }
            </code>
          </pre>         
        </section>
        <section>
          <h2>Things to avoid</h2>
          <ul>
            <li>Avoid properties that query the content tree.</li>
            <li class="fragment">Don't store data in private variables.</li>
          </ul>
        </section>       
         <section>
          <pre>
            <code data-trim data-noescape class="language-csharp medium">              
              public partial class ContentPage
              {
                private Home _homePage;
                public Home HomePage
                {
                    get
                    {
                        if (_homePage is null)
                        {
                            _homePage = this.AncestorOrSelf<Home>(1);
                        }
                        return _homePage;
                    }
                }
              }
            </code>
          </pre>         
        </section>
         <section>
          <h2>Partials location</h2>
          <p>
            You can have the generated models and your own partial classes in seperate folders.
            <br>Partials in a folder called Models
            <br>Generated fiels in a folder called Models/Generated
          </p>
        </section>
         <section>
          <h2>Partials location</h2>
          <p>
            You can have them in the same folder and have visual studio nest them.
           <br><img src="img/visual studio.png" />
          </p>
        </section>
        <section>
          <h2>Partials location</h2>
          <p>Add the following to your csproj file</p>
          <pre>
            <code data-trim data-noescape class="language-xml medium">              
              &lt;ItemGroup&gt;
                &lt;Compile Update=&quot;**\*.generated.cs&quot;&gt;
                  &lt;DependentUpon&gt;$([System.String]::Copy(%(Filename)).Replace(&#39;.generated&#39;, &#39;.cs&#39;))
                  &lt;/DependentUpon&gt;
                &lt;/Compile&gt;
              &lt;/ItemGroup&gt;
            </code>
          </pre>
        </section>
        <section>
          <h1>Custom generation</h1>
        </section>
        <section>
          <p>Use a custom modelsbuiler package. <br>
             <a href="https://marketplace.umbraco.com/package/limbo.umbraco.modelsbuilder" target="_blank">Limbo Models Builder</a></p>
        </section>
        <section>
          <p>Or implement your own generator.
            <br>Since Umbraco 11.4 you can create a class that implements <a href="https://docs.umbraco.com/umbraco-cms/reference/templating/modelsbuilder/understand-and-extend#imodelsgenerator">IModelsGenerator</a>
          </p>
        </section>

        <section>
          <h1>Thank you!</h1>
        </section>
      </div>
    </div>

    <div id="dc-logo">
      <a href="https://dotcontrol.com/">
        <img src="img/dotcontrol-colored.svg" />
      </a>
    </div>

    <script src="dist/reveal.js"></script>
    <script src="plugin/notes/notes.js"></script>
    <script src="plugin/markdown/markdown.js"></script>
    <script src="plugin/highlight/highlight.js"></script>
    <script src="plugin/highlight/cshtml-razor.min.js"></script>
    <script src="plugin/zoom/zoom.js"></script>   
    <script>
      // More info about initialization & config:
      // - https://revealjs.com/initialization/
      // - https://revealjs.com/config/
      Reveal.initialize({
        hash: true,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes, RevealZoom],

        totalTime: 1800,

        width: 1200,
        height: 700,       
      });
      
    </script>   

    <style type="text/css">
      .reveal pre {
        width: 100%;
      }

      .reveal h3 {
        text-transform: none;
      }
    </style>
  </body>
</html>
